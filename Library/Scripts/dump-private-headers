#!/bin/bash

# A utility script to dump Xcode private headers that are used in `xcnew`.
#
# This tool needs the following commands to be installed:
# See `Library/Frameworks/.versions` to know which version of the tools are needed.
#
# - [Xcode](https://developer.apple.com/download/more/)
# - [clang-format](https://clang.llvm.org/docs/ClangFormat.html)
# - [class-dump](http://stevenygard.com/projects/class-dump/)

set -e

contents_dir="$(dirname "${DEVELOPER_DIR:-$(xcode-select -p)}")"
local_frameworks_dir='Library/Frameworks'

# Dump necessary headers in DVTFoundation.framework.
class-dump -H \
           -C '^DVT(FilePath|FileSystemRepresentationProviding|Platform)$' \
           -o "$local_frameworks_dir/DVTFoundation.framework/Headers" \
           "$contents_dir/SharedFrameworks/DVTFoundation.framework"

# Dump necessary headers in IDEFoundation.framework.
class-dump -H \
           -C '^IDETemplate(|Factory|InstantiationContext|Kind|Option|OptionParent)$' \
           -o "$local_frameworks_dir/IDEFoundation.framework/Headers" \
           "$contents_dir/Frameworks/IDEFoundation.framework"

sed -f /dev/fd/0 "$local_frameworks_dir/DVTFoundation.framework/Headers/CDStructures.h" <<-'EOF' >'Library/class-dump/include/CDStructures.h'
    # Add missing imports.
    6a\
    #import <Foundation/Foundation.h>

    # Specify ownership for ARC compatibility.
    s/id \*/__unsafe_unretained &/g
EOF

find "$local_frameworks_dir" -type f -name 'CDStructures.h' -delete

find "$local_frameworks_dir" -type f -name '*.h' -exec sed -i '' -f /dev/fd/0 {} + <<-'EOF'
    # Remove C++ destructor declaration, which is not permitted in Objective-C class.
    /^- (void)\.cxx_destruct;$/d

    # Import Foundation.framework instead of importing individual headers.
    s/^#import <objc\/NSObject\.h>$/#import <Foundation\/Foundation.h>/
    /^#import "NS.*$/d

    # Use `NSUInteger` instead of an architecture-dependent type `unsigned long long`.
    s/unsigned long long hash;$/NSUInteger hash;/

    # Add an explicit ownership to avoid warnings.
    s/\(id \*_field2;\)$/__unsafe_unretained \1/
EOF

# Add missing import for `CDStructures.h`
sed -i '' -e '/#import <Foundation\/Foundation\.h>/a\
#import <CDStructures.h>' "$local_frameworks_dir/DVTFoundation.framework/Headers/DVTFilePath.h" \
                          "$local_frameworks_dir/IDEFoundation.framework/Headers/IDETemplate.h"

# Add missing header `<os/lock.h>`
sed -i '' -e '/#import <Foundation\/Foundation\.h>/a\
#import <os/lock.h>' "$local_frameworks_dir/DVTFoundation.framework/Headers/DVTFilePath.h"

# Manually add type of block which cannot be extracted with `class-dump`
sed -i '' -f /dev/fd/0 "$local_frameworks_dir/IDEFoundation.framework/Headers/IDETemplateFactory.h" <<-'EOF'
    /#import <Foundation\/Foundation.h>/{
        G
        a\
        @class DVTFilePath;
    }
    /instantiateTemplateForContext/s/CDUnknownBlockType/void (^)(NSArray<DVTFilePath *> *filePaths, void *_unknown, NSError *error)/
EOF

# Manually add C function which cannot be extracted with `class-dump`
cat <<-EOF >"$local_frameworks_dir/IDEFoundation.framework/Headers/IDEInitialization.h"
#import <Foundation/Foundation.h>

extern BOOL IDEInitialize(int initializationOptions, NSError *__autoreleasing _Nullable *_Nullable error);
extern BOOL IDEInitializationCompleted(int *_Nullable initializationOptions);
EOF

# Re-format all files.
find "$local_frameworks_dir" -type f -name '*.h' -exec clang-format -i {} +

# To reproduce the result, tool versions are recorded.
(
    exec 2>&1
    set -x
    xcodebuild -version
    class-dump --version
    clang-format --version
) >"$local_frameworks_dir/.versions"
