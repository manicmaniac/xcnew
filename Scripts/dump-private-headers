#!/bin/bash

set -e

contents_dir="$(dirname "${DEVELOPER_DIR:-$(xcode-select -p)}")"

class-dump -H \
           -C '^DVTFile(Path|SystemRepresentationProviding)$' \
           -o 'PrivateHeaders/DVTFoundation' \
           "$contents_dir/SharedFrameworks/DVTFoundation.framework"
rm -f 'PrivateHeaders/DVTFoundation/NSString-DVTFileSystemRepresentationProviding.h'

class-dump -H \
           -C '^IDETemplate(|Factory|InstantiationContext|Kind|Option|OptionParent)$' \
           -o 'PrivateHeaders/IDEFoundation' \
           "$contents_dir/Frameworks/IDEFoundation.framework"
rm -f 'PrivateHeaders/IDEFoundation/CDStructures.h'

find PrivateHeaders -type f -name '*.h' -exec sed -i '' \
    -e 's/^- (void)\.cxx_destruct;$//' \
    -e 's/^#import <objc\/NSObject\.h>$/#import <Foundation\/Foundation.h>/' \
    -e 's/unsigned long long hash;$/NSUInteger hash;/' \
    -e 's/id \*_field2;$/__unsafe_unretained id *_field2;/' \
    -e 's/^#import "NS.*$//;' \
    {} \;

sed -i '' -e '7i\
#import <os/lock.h>' PrivateHeaders/DVTFoundation/DVTFilePath.h

sed -i '' -e '7i\
#import "CDStructures.h"' PrivateHeaders/DVTFoundation/DVTFilePath.h \
                          PrivateHeaders/IDEFoundation/IDETemplate.h \
                          PrivateHeaders/IDEFoundation/IDETemplateFactory.h

find PrivateHeaders -type f -name '*.h' -exec clang-format -i {} \;

# To reproduce the result, tool versions are recorded.
(
    set -x
    xcodebuild -version
    class-dump --version
    clang-format --version
) > PrivateHeaders/versions.txt 2>&1
